# ctRestClient - Benutzerhandbuch

## √úberblick

`ctRestClient` ist ein Kommandozeilen-Tool, das den Export von Gruppen aus [ChurchTools](https://church.tools/de/home/) als CSV-Dateien erm√∂glicht. Dies ist besonders n√ºtzlich f√ºr die Erstellung von Serienbriefen mit Tools wie Microsoft Word oder Adobe InDesign.

## Hauptfunktionen

- **Export von ChurchTools-Gruppen**: Exportiert Mitgliederdaten aus dynamischen Gruppen
- **CSV-Format**: Ausgabe in standardisierten CSV-Dateien
- **Sichere Token-Verwaltung**: Verwendung von KeePass-Datenbanken f√ºr API-Token
- **Multi-Instanz-Unterst√ºtzung**: Gleichzeitiger Export von mehreren ChurchTools-Instanzen
- **Konfigurierbare Datenfelder**: Flexible Auswahl der zu exportierenden Felder
- **Plattform√ºbergreifend**: Verf√ºgbar f√ºr Windows, macOS und Linux

## Voraussetzungen

### Software-Anforderungen

1. **KeePassXC**: KeePassXC muss installiert sein und das Kommandozeilen-Tool `keepassxc-cli` muss im System-PATH verf√ºgbar sein
   - **Windows**: `keepassxc-cli.exe` befindet sich meist unter `Program Files/KeePassXC`
   - **macOS**: `keepassxc-cli` befindet sich meist unter `/Applications/KeePassXC.app/Contents/MacOS`
   - **Linux**: `keepassxc-cli` befindet sich meist unter `/usr/bin` oder `/usr/local/bin`
   
   **Wichtig**: Ohne `keepassxc-cli` im PATH kann ctRestClient nicht auf die Token-Datenbank zugreifen!

2. **ChurchTools-Zugang**: 
   - G√ºltiger API-Token f√ºr jede ChurchTools-Instanz
   - Berechtigung zum Lesen der entsprechenden Gruppen

### Hardware-Anforderungen

- Minimal: Beliebiges System mit ausreichend Speicher f√ºr die zu exportierenden Daten

## Installation

### 1. Executable herunterladen

Laden Sie die entsprechende Version f√ºr Ihr Betriebssystem herunter:

| Plattform | Architektur | Download Link |
|-----------|-------------|---------------|
| üêß Linux | x86_64 | [ctRestClient_${version_no_v}_linux_x86_64.tar.gz](https://github.com/mvach/ctRestClient/releases/download/${version}/ctRestClient_${version_no_v}_linux_x86_64.tar.gz) |
| üçé macOS | Intel (x86_64) | [ctRestClient_${version_no_v}_darwin_x86_64.tar.gz](https://github.com/mvach/ctRestClient/releases/download/${version}/ctRestClient_${version_no_v}_darwin_x86_64.tar.gz) |
| üçé macOS | Apple Silicon (ARM64) | [ctRestClient_${version_no_v}_darwin_arm64.tar.gz](https://github.com/mvach/ctRestClient/releases/download/${version}/ctRestClient_${version_no_v}_darwin_arm64.tar.gz) |
| ü™ü Windows | x86_64 | [ctRestClient_${version_no_v}_windows_x86_64.tar.gz](https://github.com/mvach/ctRestClient/releases/download/${version}/ctRestClient_${version_no_v}_windows_x86_64.tar.gz) |

[üìã Alle Releases anzeigen](https://github.com/mvach/ctRestClient/releases/tag/${version})

### 2. KeePass-Datenbank einrichten

Erstellen Sie eine KeePass-Datenbank (`.kdbx`-Datei) und speichern Sie Ihre ChurchTools-API-Token:

1. √ñffnen Sie KeePassXC
2. Erstellen Sie eine neue Datenbank
3. F√ºr jede ChurchTools-Instanz erstellen Sie einen Eintrag:
   - **Titel**: Ein eindeutiger Name (z.B. `meineKirche`)
   - **Passwort**: Ihr ChurchTools-API-Token
4. Speichern Sie die Datenbank als `churchtools-tokens.kdbx` (empfohlener Name)

### 3. Ordnerstruktur

Erstellen Sie folgende Ordnerstruktur:
```
mein-projekt/
‚îú‚îÄ‚îÄ ctRestClient-[platform]        # Die Executable
‚îú‚îÄ‚îÄ config.yml                     # Konfigurationsdatei
‚îú‚îÄ‚îÄ churchtools-tokens.kdbx        # KeePass-Datenbank
‚îú‚îÄ‚îÄ data/                          # ggf. Daten f√ºr Wertumwandlungen
‚îî‚îÄ‚îÄ exports/                       # Ausgabeverzeichnis (wird automatisch erstellt)
```

## Konfiguration

### Grundlegende Konfiguration

Die Konfiguration erfolgt √ºber eine YAML-Datei. Hier ein Beispiel (`config.yml`):

```yaml
instances:
  - hostname: meineKirche.de
    token_name: meineKirche
    groups:
    - name: Konfirmanden
      fields: [id, firstName, lastName, sexId, street, zip, city]
    - name: Eltern von Konfirmanden
      fields: [id, firstName, lastName, sexId, email]
```

### Konfigurationsparameter

#### Instanzen (`instances`)
- **hostname**: Die Dom√§ne Ihrer ChurchTools-Instanz (ohne https://)
- **token_name**: Name des Token-Eintrags in der KeePass-Datenbank
- **groups**: Liste der zu exportierenden Gruppen

#### Gruppen (`groups`)
- **name**: Exakter Name der Gruppe in ChurchTools
- **fields**: Liste der zu exportierenden Datenfelder

### Erweiterte Feldkonfiguration

#### Wertumwandlung mit benutzerdefinierten Spaltennamen

`ctRestClient` unterst√ºtzt die automatische Umwandlung von ChurchTools-Werten in benutzerfreundlichere Ausgaben. Gleichzeitig k√∂nnen Sie dabei auch die Spaltennamen in der CSV-Ausgabe anpassen.

**Funktionsweise:**
- Werte werden aus YAML-Dateien im `data/`-Verzeichnis gelesen
- Der Pfad folgt dem Schema: `data/<modul>/<feldname>.yml`
- F√ºr das Feld `sexId` im Modul `persons`: `data/persons/sexId.yml`
- Spaltennamen k√∂nnen mit `columnname` angepasst werden

**Beispiel f√ºr die Umwandlung der sexId-Werte:**

Erstellen Sie die Datei `data/persons/sexId.yml`:
```yaml
1: m√§nnlich
2: weiblich
3: divers
```

**Konfiguration:**
```yaml
fields: 
  - id
  - firstName
  - lastName
  - {fieldname: sexId, columnname: "geschlecht"}
  - birthday
```

### Beispielkonfigurationen

#### Geburtstagslisten

```yaml
instances:
  - hostname: meineKirche.de
    token_name: meineKirche
    groups:
    - name: Konfirmanden
      fields: [id, firstName, lastName, sexId, street, zip, city]
    - name: Eltern von Konfirmanden
      fields: [id, firstName, lastName, sexId, email]
```

#### Multi-Instanz-Setup

```yaml
instances:
  - hostname: kumulus.meineKirche.de
    token_name: kumulus
    groups:
    - name: Kindergottesdienst
      fields: [id, firstName, lastName]
  - hostname: stratus.meineKirche.de
    token_name: stratus
    groups:
    - name: Jugendgruppe
      fields: [id, firstName, lastName, email]
```

## Verwendung

### Kommandozeilen-Parameter

```bash
ctRestClient [OPTIONS]
```

#### Verf√ºgbare Optionen:

- **`-c <pfad>`**: Pfad zur Konfigurationsdatei
  - Standard: `config.yml` im Verzeichnis der Executable
- **`-k <pfad>`**: Pfad zur KeePass-Datenbank
  - Standard: `passwords.kdbx` im Verzeichnis der Executable
- **`-o <pfad>`**: Ausgabeverzeichnis f√ºr CSV-Dateien
  - Standard: `exports/` im Verzeichnis der Executable
- **`-d <pfad>`**: Pfad zum Datenverzeichnis f√ºr Wertumwandlungen
  - Standard: `data/` im Verzeichnis der Executable

### Grundlegende Ausf√ºhrung

#### Windows
```cmd
ctRestClient-windows-amd64.exe
```

#### macOS
```bash
./ctRestClient-darwin-arm64  # F√ºr Apple Silicon
./ctRestClient-darwin-amd64  # F√ºr Intel-Macs
```

#### Linux
```bash
./ctRestClient-linux-amd64
```

### Ausf√ºhrung mit benutzerdefinierten Pfaden

```bash
# Mit spezifischer Konfiguration
./ctRestClient-linux-amd64 -c /pfad/zu/meiner/config.yml

# Mit spezifischer KeePass-Datenbank
./ctRestClient-linux-amd64 -k /pfad/zu/tokens.kdbx

# Mit spezifischem Ausgabeverzeichnis
./ctRestClient-linux-amd64 -o /pfad/zu/exports/

# Mit spezifischem Datenverzeichnis
./ctRestClient-linux-amd64 -d /pfad/zu/data/

# Kombination aller Parameter
./ctRestClient-linux-amd64 -c config.yml -k tokens.kdbx -o exports/ -d data/
```

### Automatisierung mit Skripten

#### Bash-Skript f√ºr Linux/macOS (`export.sh`)

```bash
#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Plattform erkennen
OS=$(uname -s)
ARCH=$(uname -m)

case "$OS" in
    "Darwin")
        export PATH=$PATH:/Applications/KeePassXC.app/Contents/MacOS
        case "$ARCH" in
            "arm64")
                EXECUTABLE="$SCRIPT_DIR/ctRestClient-darwin-arm64"
                ;;
            "x86_64")
                EXECUTABLE="$SCRIPT_DIR/ctRestClient-darwin-amd64"
                ;;
        esac
        ;;
    "Linux")
        export PATH=$PATH:/usr/bin:/usr/local/bin
        EXECUTABLE="$SCRIPT_DIR/ctRestClient-linux-amd64"
        ;;
esac

# Ausf√ºhrung
chmod +x "$EXECUTABLE"
"$EXECUTABLE" -k "$HOME/churchtools-tokens.kdbx" -c "$SCRIPT_DIR/config.yml"
```

#### Batch-Skript f√ºr Windows (`export.bat`)

```batch
@echo off
set SCRIPT_DIR=%~dp0
set EXECUTABLE=%SCRIPT_DIR%ctRestClient-windows-amd64.exe

"%EXECUTABLE%" -k "%USERPROFILE%\churchtools-tokens.kdbx" -c "%SCRIPT_DIR%config.yml"
pause
```

## Ausgabe

### Dateistruktur

Der Export erstellt folgende Struktur:

```
exports/
‚îî‚îÄ‚îÄ [DATUM]_[ZEIT]/
    ‚îú‚îÄ‚îÄ ctRestClient.log
    ‚îî‚îÄ‚îÄ [HOSTNAME]/
        ‚îú‚îÄ‚îÄ [Gruppenname_1].csv
        ‚îú‚îÄ‚îÄ [Gruppenname_2].csv
        ‚îî‚îÄ‚îÄ ...
```

Beispiel:
```
exports/
‚îî‚îÄ‚îÄ 2025.08.06_14-30-15/
    ‚îú‚îÄ‚îÄ ctRestClient.log
    ‚îî‚îÄ‚îÄ ihre-kirche.krz.tools/
        ‚îú‚îÄ‚îÄ Konfirmanden.csv
        ‚îî‚îÄ‚îÄ Eltern_von_Konfirmanden.csv
```

### CSV-Format

Die CSV-Dateien verwenden:
- **Trennzeichen**: Semikolon (`;`)
- **Kodierung**: UTF-16 Little Endian mit BOM
- **Erste Zeile**: Spalten√ºberschriften

Beispiel-Inhalt:
```csv
id;firstName;lastName;street;zip;city
123;Max;Mustermann;Musterstra√üe 1;12345;Musterstadt
124;Maria;Musterfrau;Beispielweg 2;54321;Beispielort
```

## Logging

Detaillierte Informationen √ºber die Ausf√ºhrung finden Sie in der `ctRestClient.log`-Datei im Ausgabeverzeichnis. Diese enth√§lt:
- Zeitstempel aller Aktionen
- Erfolgreiche Exports
- Fehlermeldungen mit Details
- Performance-Informationen

## Best Practices

### Sicherheit

1. **KeePass-Datenbank sch√ºtzen**: Verwenden Sie ein starkes Master-Passwort
2. **API-Token rotieren**: Erneuern Sie regelm√§√üig Ihre ChurchTools-Token
3. **KeePassXC aktuell halten**: Installieren Sie regelm√§√üig Updates f√ºr KeePassXC, um Sicherheitsl√ºcken zu schlie√üen
4. **Dateiberechtigungen**: Beschr√§nken Sie den Zugriff auf Konfigurationsdateien
5. **Sichere √úbertragung**: Stellen Sie sicher, dass ChurchTools √ºber HTTPS erreichbar ist

### Performance

1. **Feldauswahl optimieren**: Exportieren Sie nur ben√∂tigte Felder
2. **Gruppengr√∂√üe beachten**: Bei sehr gro√üen Gruppen kann der Export l√§nger dauern
3. **Netzwerkverbindung**: Verwenden Sie eine stabile Internetverbindung

### Organisation

1. **Sinnvolle Dateinamen**: Verwenden Sie aussagekr√§ftige Konfigurationsdateinamen
2. **Konfigurations-Backups**: Erstellen Sie regelm√§√üig Backups Ihrer Konfigurationsdateien
3. **Dokumentation**: Dokumentieren Sie spezielle Konfigurationen f√ºr Ihr Team
4. **Automatisierung**: Nutzen Sie Skripte f√ºr wiederkehrende Exporte

---

### Lizenz

Dieses Projekt steht unter der MIT-Lizenz. Siehe [LICENSE](LICENSE.md)-Datei f√ºr Details.
